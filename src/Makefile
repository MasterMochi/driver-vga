#******************************************************************************#
# src/Makefile                                                                 #
#                                                                   2019/01/31 #
# Copyright (C) 2019 Mochi.                                                    #
#******************************************************************************#
#******************************************************************************#
#* 定義                                                                       *#
#******************************************************************************#
# プログラム名
PROG = drv-vga

# ソースコード
SRCS = main.c \
       Vram.c

# ビルドディレクトリ
BUILD_DIR = ../build

# オブジェクトファイル生成先ディレクトリ
OBJ_DIR = $(BUILD_DIR)/obj

# Cフラグ
CFLAGS = -ffreestanding         \
         -nostdlib              \
         -m32                   \
         -fno-pic               \
         -static                \
         -masm=intel            \
         -I$(BUILD_DIR)/include \
         -Iinclude

# LDフラグ
LDFLAGS = -Tdrv-vga.lds      \
          -melf_i386         \
          -L$(BUILD_DIR)/lib

# ライブラリ
LIBS = -lc  \
       -lMk


#******************************************************************************#
# マクロ                                                                      *#
#******************************************************************************#
# オブジェクトサブディレクトリ
OBJ_SUBDIRS = $(sort $(addprefix $(OBJ_DIR)/, $(dir $(SRCS))))

# オブジェクトファイル
OBJS = $(addprefix $(OBJ_DIR)/, $(SRCS:.c=.o))

# 依存関係ファイル
DEPS = $(addprefix $(OBJ_DIR)/, $(SRCS:.c=.d))


#******************************************************************************#
#* phonyターゲット                                                            *#
#******************************************************************************#
.PHONY: all
all: $(OBJ_SUBDIRS) $(BUILD_DIR)/$(PROG) Makefile

.PHONY: clean
clean:
	-rm -rf $(BUILD_DIR)/$(PROG)
	-rm -rf $(OBJ_DIR)


#******************************************************************************#
#* 生成規則                                                                   *#
#******************************************************************************#
# 依存関係ファイル
-include $(DEPS)

# サブディレクトリ生成
ifdef OBJ_SUBDIRS
$(OBJ_SUBDIRS):
	mkdir -p $@
endif

# 実行ファイル生成
$(BUILD_DIR)/$(PROG): $(OBJS) Makefile
	$(LD) $(LDFLAGS) -o $(OBJ_DIR)/$(PROG) $(OBJS) $(LIBS)
	ln -sfr $(OBJ_DIR)/$(PROG) $@

# コンパイル
$(OBJ_DIR)/%.o: %.c Makefile
	$(CC) $(CFLAGS) -o $@ -c $< -MD -MP


#******************************************************************************#
